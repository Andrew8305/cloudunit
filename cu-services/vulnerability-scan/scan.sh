#!/bin/bash

SCANDIR=$(dirname $0)

pushd $SCANDIR && docker-compose up -d
popd

IMAGES=$(docker images --filter "reference=cloudunit/*" --format="{{.Repository}}:{{.Tag}}")
CLAIRCTLOPTS=--no-clean

for IMAGE in $IMAGES
do
	echo "Scanning $IMAGE ..."
	docker exec clairctl clairctl pull -l $IMAGE $CLAIRCTLOPTS && \
	docker exec clairctl clairctl analyze -l $IMAGE $CLAIRCTLOPTS && \
	docker exec clairctl clairctl report -l $IMAGE $CLAIRCTLOPTS && \
	echo "done" || \
	echo "ERROR"
done

pushd $SCANDIR && docker-compose down -v
popd
